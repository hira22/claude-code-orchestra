#!/bin/bash
# Claude Code Orchestra åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«orchestraç’°å¢ƒã‚’é©ç”¨ã—ã¾ã™

set -e

TEMPLATE_DIR="$HOME/.claude-orchestra-template"

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèª
if [ ! -d "$TEMPLATE_DIR" ]; then
    echo "ã‚¨ãƒ©ãƒ¼: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $TEMPLATE_DIR"
    exit 1
fi

echo "ğŸ¼ Claude Code Orchestra ç’°å¢ƒã‚’é©ç”¨ã—ã¾ã™..."

# settings.jsonãƒãƒ¼ã‚¸é–¢æ•°
merge_settings_json() {
    local existing="$1"
    local template="$2"
    local output="$3"

    # jqã§æ—¢å­˜è¨­å®šã‚’ä¿æŒã—ã¤ã¤orchestraã®è¨­å®šã‚’è¿½åŠ 
    # hooksã¯é…åˆ—ã‚’çµåˆã—ã¦é‡è¤‡æ’é™¤
    jq -s '
        .[0] as $existing |
        .[1] as $template |

        # hooksé…åˆ—ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹é–¢æ•°ï¼ˆcommandã§é‡è¤‡åˆ¤å®šï¼‰
        def merge_hooks($a; $b):
            ($a // []) + ($b // []) | unique_by(.hooks[0].command // .);

        ($existing // {}) + {
            hooks: {
                UserPromptSubmit: merge_hooks($existing.hooks.UserPromptSubmit; $template.hooks.UserPromptSubmit),
                PreToolUse: merge_hooks($existing.hooks.PreToolUse; $template.hooks.PreToolUse),
                PostToolUse: merge_hooks($existing.hooks.PostToolUse; $template.hooks.PostToolUse)
            },
            permissions: {
                allow: (($existing.permissions.allow // []) + ($template.permissions.allow // [])) | unique,
                deny: (($existing.permissions.deny // []) + ($template.permissions.deny // [])) | unique,
                ask: ($existing.permissions.ask // []),
                defaultMode: ($existing.permissions.defaultMode // "normal")
            },
            env: (($existing.env // {}) + ($template.env // {}))
        }
    ' "$existing" "$template" > "$output"
}

# .claudeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ”ãƒ¼
if [ -d ".claude" ]; then
    echo "âš ï¸  .claude/ ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    read -r response
    if [ "$response" = "y" ]; then
        # settings.jsonä»¥å¤–ã‚’æ—¢å­˜ä¿æŒã§ã‚³ãƒ”ãƒ¼
        find "$TEMPLATE_DIR/.claude" -mindepth 1 -maxdepth 1 -not -name "settings.json" -exec cp -rn {} .claude/ \; 2>/dev/null || true

        # settings.jsonã¯åˆ¥é€”ãƒãƒ¼ã‚¸
        if [ -f ".claude/settings.json" ]; then
            echo "  â†’ settings.json ã‚’ãƒãƒ¼ã‚¸ä¸­..."
            merge_settings_json ".claude/settings.json" "$TEMPLATE_DIR/.claude/settings.json" ".claude/settings.json.tmp"
            mv ".claude/settings.json.tmp" ".claude/settings.json"
            echo "  âœ“ settings.json ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸï¼ˆhooksè¿½åŠ ã€permissionsçµ±åˆï¼‰"
        else
            cp "$TEMPLATE_DIR/.claude/settings.json" .claude/
            echo "  âœ“ settings.json ã‚’ä½œæˆã—ã¾ã—ãŸ"
        fi

        echo "âœ“ .claude/ ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸ"
    else
        echo "â†’ .claude/ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
    fi
else
    cp -r "$TEMPLATE_DIR/.claude" .
    echo "âœ“ .claude/ ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

# .codexãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ”ãƒ¼
if [ -d ".codex" ]; then
    echo "âš ï¸  .codex/ ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    read -r response
    if [ "$response" = "y" ]; then
        cp -r "$TEMPLATE_DIR/.codex" .
        echo "âœ“ .codex/ ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ"
    else
        echo "â†’ .codex/ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
    fi
else
    cp -r "$TEMPLATE_DIR/.codex" .
    echo "âœ“ .codex/ ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

# .geminiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ”ãƒ¼
if [ -d ".gemini" ]; then
    echo "âš ï¸  .gemini/ ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    read -r response
    if [ "$response" = "y" ]; then
        cp -r "$TEMPLATE_DIR/.gemini" .
        echo "âœ“ .gemini/ ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ"
    else
        echo "â†’ .gemini/ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
    fi
else
    cp -r "$TEMPLATE_DIR/.gemini" .
    echo "âœ“ .gemini/ ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

echo ""
echo "ğŸ‰ Orchestraç’°å¢ƒã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ«:"
echo "  /startproject - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå”èª¿ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹"
echo "  /plan         - å®Ÿè£…è¨ˆç”»ä½œæˆ"
echo "  /tdd          - ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º"
echo "  /codex-system - Codex CLIé€£æº"
echo "  /gemini-system - Gemini CLIé€£æº"
echo ""
echo "claudeã‚’èµ·å‹•ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚"
